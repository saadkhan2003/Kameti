rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the host of a committee
    function isCommitteeHost(committeeId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/committees/$(committeeId)).data.hostId == request.auth.uid;
    }
    
    // COMMITTEES collection
    match /committees/{committeeId} {
      // Allow read if user is the host OR if user has the committee code (for joining)
      allow read: if isAuthenticated() && 
                     (resource.data.hostId == request.auth.uid || 
                      request.auth != null);
      
      // Allow create/update only if user is the host
      allow create: if isAuthenticated() && 
                       request.resource.data.hostId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
                       resource.data.hostId == request.auth.uid;
      
      // Allow delete only if user is the host
      allow delete: if isAuthenticated() && 
                       resource.data.hostId == request.auth.uid;
    }
    
    // MEMBERS collection
    match /members/{memberId} {
      // Allow read if user is the committee host OR the member themselves
      allow read: if isAuthenticated() && 
                     (isCommitteeHost(resource.data.committeeId) || 
                      resource.data.userId == request.auth.uid);
      
      // Allow create/update/delete only if user is the committee host
      allow create, update, delete: if isAuthenticated() && 
                                       isCommitteeHost(request.resource.data.committeeId);
    }
    
    // PAYMENTS collection
    match /payments/{paymentId} {
      // Allow read if user is the committee host OR a member of the committee
      allow read: if isAuthenticated() && 
                     isCommitteeHost(resource.data.committeeId);
      
      // Allow create/update/delete only if user is the committee host
      allow create, update, delete: if isAuthenticated() && 
                                       isCommitteeHost(request.resource.data.committeeId);
    }
  }
}
